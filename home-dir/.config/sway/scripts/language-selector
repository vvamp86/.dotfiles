#!/bin/bash

profile="/home/sudowoodo/.config/fcitx5/profile"

# Get engines from Items sections
engines=()
while IFS= read -r line; do
    if [[ "$line" == Name=* ]] && [[ "$prev_line" == \[Groups/0/Items/* ]]; then
        engines+=("${line#Name=}")
    fi
    prev_line="$line"
done < "$profile"

# Fallback if parsing fails
if [[ ${#engines[@]} -eq 0 ]]; then
    engines=("keyboard-us" "keyboard-cn-altgr-pinyin")
fi

# Create readable names
options=()
for engine in "${engines[@]}"; do
    case "$engine" in
        keyboard-us) options+=("English (US)") ;;
        keyboard-cn-altgr-pinyin) options+=("Chinese Pinyin") ;;
        *) options+=("$engine") ;;
    esac
done

# Get current and find index
current=$(fcitx5-remote -n 2>/dev/null)
selected_index=0
for i in "${!engines[@]}"; do
    if [[ "${engines[$i]}" == "$current" ]] || \
       [[ "${options[$i]}" == "$current" ]]; then
        selected_index=$i
        break
    fi
done

# Show menu
selected=$(printf "%s\n" "${options[@]}" | rofi -dmenu -p "Input Method" -config ~/.config/rofi/rofidmenu.rasi -selected-row $selected_index )

# Find and switch
for i in "${!options[@]}"; do
    if [[ "${options[$i]}" == "$selected" ]]; then
        fcitx5-remote -s "${engines[$i]}" 2>/dev/null || fcitx5-remote -t
        break
    fi
done
